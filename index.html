<!DOCTYPE html>
<html>

<head>
    <title>QR Code Scanner full</title>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #numberBox {
            width: 200px;
            height: 30px;
            text-align: center;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .button {
            width: 60px;
            height: 40px;
            background-color: #e0e0e0;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        #backspaceButton {
            background-color: #ffcccc;
        }

        #transactionButton {
            width: 120px;
            height: 40px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }

        #receiveButton {
            width: 120px;
            height: 40px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }

        #resultBox {
            margin-top: 20px;
            display: none;
        }

        #resultBox p {
            font-size: 18px;
        }
    </style>
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
</head>

<body>
    <div class="container">
        <button id="receiveBalanceButton" onclick="showReceiveBalance()">Receive Balance</button>
        <button id="makeTransactionButton" onclick="startTransaction()">Make Transaction</button>
    </div>

    <!-- Receive Balance Step -->
    <div id="receiveBalanceStep" style="display: none;">
        <div class="container">
            <div id="numberBox"></div>
            <div class="buttons">
                <div class="button" onclick="addNumber(1)">1</div>
                <div class="button" onclick="addNumber(2)">2</div>
                <div class="button" onclick="addNumber(3)">3</div>
                <div class="button" onclick="addNumber(4)">4</div>
                <div class="button" onclick="addNumber(5)">5</div>
                <div class="button" onclick="addNumber(6)">6</div>
                <div class="button" onclick="addNumber(7)">7</div>
                <div class="button" onclick="addNumber(8)">8</div>
                <div class="button" onclick="addNumber(9)">9</div>
                <div id="backspaceButton" class="button" onclick="backspace()">⌫</div>
            </div>
            <button id="nextStepButton" onclick="goToPasswordStep()">Next Step</button>
        </div>
    </div>

    <!-- Password Step -->
    <div id="passwordStep" style="display: none;">
        <div class="container">
            <div id="passwordBox"></div>
            <div class="buttons">
                <div class="button" onclick="addNumber(1)">1</div>
                <div class="button" onclick="addNumber(2)">2</div>
                <div class="button" onclick="addNumber(3)">3</div>
                <div class="button" onclick="addNumber(4)">4</div>
                <div class="button" onclick="addNumber(5)">5</div>
                <div class="button" onclick="addNumber(6)">6</div>
                <div class="button" onclick="addNumber(7)">7</div>
                <div class="button" onclick="addNumber(8)">8</div>
                <div class="button" onclick="addNumber(9)">9</div>
                <div id="backspaceButton" class="button" onclick="backspace()">⌫</div>
            </div>
            <button id="checkPasswordButton" onclick="checkPassword()">Check Password</button>
        </div>
    </div>

    <!-- Transaction Result -->
    <div id="resultBox">
        <p id="transactionResult"></p>
    </div>

    <video id="preview" style="display: none;"></video>

    <script>
        let cards = [
            { card: 12345678, code: 1234, name: 'mohamad', value: 2000 },
            { card: 23457681, code: 5661, name: 'sobhan', value: 11000 }
        ]
        let scanner;
        let enteredCode = '';
        let enteredPassword = '';
        let code;
        let transactionStarted = false;

        function addNumber(number) {
            if (transactionStarted) {
                if (enteredCode.length < 4) {
                    enteredCode += number;
                    updateNumberBox();
                }
            } else {
                if (enteredPassword.length < 8) {
                    enteredPassword += number;
                    updatePasswordBox();
                }
            }
        }

        function backspace() {
            if (transactionStarted) {
                enteredCode = enteredCode.slice(0, -1);
                updateNumberBox();
            } else {
                enteredPassword = enteredPassword.slice(0, -1);
                updatePasswordBox();
            }
        }

        function updateNumberBox() {
            document.getElementById('numberBox').innerText = enteredCode;
        }

        function updatePasswordBox() {
            document.getElementById('passwordBox').innerText = enteredPassword;
        }

        function showReceiveBalance() {
            document.getElementById('receiveBalanceButton').style.display = 'none';
            document.getElementById('makeTransactionButton').style.display = 'none';
            document.getElementById('receiveBalanceStep').style.display = 'block';
        }

        function goToPasswordStep() {
            document.getElementById('receiveBalanceStep').style.display = 'none';
            document.getElementById('passwordStep').style.display = 'block';
        }

        function checkPassword() {
            const cardNumber = parseInt(enteredCode);
            const password = parseInt(enteredPassword);

            const card = cards.find(c => c.card === cardNumber && c.code === password);

            if (card) {
                updateNumberBox();
                enteredCode = '';
                enteredPassword = '';
                document.getElementById('passwordStep').style.display = 'none';
                document.getElementById('preview').style.display = 'block';

                scanner = new Instascan.Scanner({ video: document.getElementById('preview'), mirror: false });

                scanner.addListener('scan', function (content) {
                    if (content === enteredCode) {
                        transactionStarted = false;

                        // Find the card in the array
                        const selectedCard = cards.find(c => c.card === cardNumber);

                        if (selectedCard) {
                            // Subtract the transaction amount from the card's value
                            selectedCard.value -= enteredCode;

                            // Add the transaction amount to the recipient's card value
                            const recipientCard = cards.find(c => c.code === code);
                            if (recipientCard) {
                                recipientCard.value += enteredCode;
                            }

                            // Display the transaction result
                            document.getElementById('transactionResult').innerText = `Transaction Successful!\n\nFrom: ${card.name}\nAmount: ${enteredCode}\nTo: ${recipientCard.name}`;

                            // Reset the entered values after 3 seconds
                            setTimeout(resetValues, 3000);
                        }

                        scanner.stop();
                        document.querySelector('.container').style.display = 'flex';
                        document.getElementById('preview').style.display = 'none';
                    }
                });

                Instascan.Camera.getCameras().then(function (cameras) {
                    if (cameras.length > 0) {
                        scanner.start(cameras[cameras.length - 1]);
                    } else {
                        console.error('No cameras found.');
                    }
                }).catch(function (e) {
                    console.error(e);
                });
            } else {
                alert('Invalid card number or password. Please try again.');
                enteredPassword = '';
                updatePasswordBox();
            }
        }

        function startTransaction() {
            document.getElementById('receiveBalanceButton').style.display = 'none';
            document.getElementById('makeTransactionButton').style.display = 'none';
            document.getElementById('passwordStep').style.display = 'block';

            transactionStarted = true;
        }

        function resetValues() {
            document.getElementById('transactionResult').innerText = '';
            enteredCode = '';
            updateNumberBox();
            document.getElementById('resultBox').style.display = 'none';
            document.getElementById('preview').style.display = 'block';

            scanner.start();
        }
    </script>
</body>

</html>
